name: Project Item Monitor

on:
  projects_v2_item:
    types: [created, edited, moved]
  workflow_dispatch:
    inputs:
      project_number:
        description: 'Project number to monitor'
        required: false
        default: '5'

permissions:
  contents: read
  issues: read
  pull-requests: read
  actions: read
  projects: read

jobs:
  monitor-project-item:
    runs-on: ubuntu-latest
    if: github.event.projects_v2_item.project_node_id == 'PVT_kwHOAw5gVs4ATpZZ' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Get project item details
        if: github.event_name == 'projects_v2_item'
        id: item-details
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Event type: ${{ github.event.action }}"
          echo "Item ID: ${{ github.event.projects_v2_item.id }}"
          echo "Project ID: ${{ github.event.projects_v2_item.project_node_id }}"
          
          # ç²å– item è©³ç´°è³‡è¨Š
          ITEM_ID="${{ github.event.projects_v2_item.id }}"
          PROJECT_ID="${{ github.event.projects_v2_item.project_node_id }}"
          
          # ä½¿ç”¨ GraphQL API ç²å– item è©³æƒ…
          QUERY='query($itemId: ID!) {
            node(id: $itemId) {
              ... on ProjectV2Item {
                id
                createdAt
                updatedAt
                content {
                  ... on Issue {
                    title
                    number
                    state
                    url
                    body
                  }
                  ... on PullRequest {
                    title
                    number
                    state
                    url
                    body
                  }
                  ... on DraftIssue {
                    title
                    body
                  }
                }
                fieldValues(first: 10) {
                  nodes {
                    ... on ProjectV2ItemFieldTextValue {
                      text
                      field {
                        ... on ProjectV2Field {
                          name
                        }
                      }
                    }
                    ... on ProjectV2ItemFieldSingleSelectValue {
                      name
                      field {
                        ... on ProjectV2SingleSelectField {
                          name
                        }
                      }
                    }
                  }
                }
              }
            }
          }'
          
          RESPONSE=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -X POST \
            -d "{\"query\": \"$QUERY\", \"variables\": {\"itemId\": \"$ITEM_ID\"}}" \
            https://api.github.com/graphql)
          
          echo "Item details:"
          echo "$RESPONSE" | jq '.'

      - name: Check if item is in Backlog status
        if: github.event_name == 'projects_v2_item' && github.event.action == 'created'
        id: check-backlog
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # é€™è£¡å¯ä»¥æ ¹æ“šéœ€è¦æª¢æŸ¥ item æ˜¯å¦ç‚º Backlog ç‹€æ…‹
          # ç›®å‰ç°¡åŒ–è™•ç†ï¼Œé è¨­æ‰€æœ‰æ–°å‰µå»ºçš„ item éƒ½éœ€è¦è™•ç†
          echo "new_backlog_item=true" >> $GITHUB_OUTPUT
          echo "âœ… æ–°çš„ Project item éœ€è¦è™•ç†"

      - name: Execute project item task
        if: steps.check-backlog.outputs.new_backlog_item == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CLAUDE_CLI_PATH: claude
          PROJECT_DIR: ${{ github.workspace }}
          REQUEST_COMMIT: "false"
        run: |
          echo "ğŸš€ åŸ·è¡Œ Project item ç›£æ§è…³æœ¬..."
          
          # é€™è£¡å¯ä»¥åŸ·è¡Œç›¸é—œçš„è‡ªå‹•åŒ–ä»»å‹™
          # ç”±æ–¼é€™æ˜¯åœ¨ GitHub Actions ç’°å¢ƒä¸­ï¼Œæˆ‘å€‘éœ€è¦èª¿æ•´åŸ·è¡Œæ–¹å¼
          
          echo "ğŸ“‹ Project item å·²è¢«æª¢æ¸¬åˆ°ä¸¦è™•ç†"
          echo "ğŸ·ï¸  Event: ${{ github.event.action }}"
          echo "ğŸ†” Item ID: ${{ github.event.projects_v2_item.id }}"

      - name: Notify completion
        if: always()
        run: |
          if [ "${{ steps.check-backlog.outputs.new_backlog_item }}" == "true" ]; then
            echo "âœ… Project item ç›£æ§å®Œæˆ"
            echo "ğŸ“Š è™•ç†ç‹€æ…‹: æˆåŠŸ"
          else
            echo "â„¹ï¸  No action required for this item"
          fi