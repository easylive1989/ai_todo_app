name: GitHub Project Monitor

on:
  schedule:
    # æ¯ 1 åˆ†é˜åŸ·è¡Œä¸€æ¬¡
    - cron: '* * * * *'
  workflow_dispatch:
    # æ”¯æ´æ‰‹å‹•è§¸ç™¼
    inputs:
      force_run:
        description: 'å¼·åˆ¶åŸ·è¡Œï¼ˆå³ä½¿æ²’æœ‰æ–°ä»»å‹™ï¼‰'
        required: false
        default: 'false'
        type: boolean

jobs:
  check-project-items:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      actions: write
      id-token: write

    outputs:
      has_tasks: ${{ steps.process_items.outputs.has_tasks }}
      task_count: ${{ steps.process_items.outputs.task_count }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests python-dotenv

      - name: Download previous processed items
        uses: actions/download-artifact@v4
        with:
          name: processed-items
          path: ./
        continue-on-error: true

      - name: Process Project Items
        id: process_items
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          cd scripts
          python process_project_items.py

      - name: Upload processed items state
        uses: actions/upload-artifact@v4
        with:
          name: processed-items
          path: scripts/processed_items.json
          retention-days: 30
        if: always()

      - name: Upload task file
        uses: actions/upload-artifact@v4
        with:
          name: claude-tasks-${{ github.run_number }}
          path: scripts/claude_tasks.txt
          retention-days: 7
        if: steps.process_items.outputs.has_tasks == 'true'

  process-with-claude:
    needs: check-project-items
    if: needs.check-project-items.outputs.has_tasks == 'true' || github.event.inputs.force_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      actions: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´æ­·å²è¨˜éŒ„ä»¥ä¾¿ commit

      - name: Download task file
        uses: actions/download-artifact@v4
        with:
          name: claude-tasks-${{ github.run_number }}
          path: ./

      - name: Read task content
        id: read_tasks
        run: |
          if [ -f claude_tasks.txt ]; then
            # è®€å–æª”æ¡ˆå…§å®¹ä¸¦è¨­å®šç‚º output
            {
              echo "content<<EOF"
              cat claude_tasks.txt
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          else
            echo "content=No tasks found" >> "$GITHUB_OUTPUT"
          fi

      - name: Display tasks to be processed
        run: |
          echo "ğŸ“‹ å³å°‡è™•ç†çš„ä»»å‹™ï¼š"
          echo "ä»»å‹™æ•¸é‡: ${{ needs.check-project-items.outputs.task_count }}"
          echo ""
          if [ -f claude_tasks.txt ]; then
            echo "ä»»å‹™å…§å®¹é è¦½ï¼š"
            head -20 claude_tasks.txt
            if [ $(wc -l < claude_tasks.txt) -gt 20 ]; then
              echo "..."
              echo "ï¼ˆå…§å®¹å·²æˆªæ–·ï¼Œå®Œæ•´å…§å®¹å°‡å‚³é€çµ¦ Claudeï¼‰"
            fi
          fi

      - name: Process tasks with Claude Code
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          
          # ç›´æ¥å‚³éä»»å‹™å…§å®¹ä½œç‚º prompt
          prompt: |
            é€™äº›æ˜¯ä¾†è‡ª GitHub Project çš„æ–°ä»»å‹™ï¼Œè«‹æŒ‰ç…§ä»»å‹™å…§å®¹åŸ·è¡Œç›¸æ‡‰çš„é–‹ç™¼å·¥ä½œï¼š

            ${{ steps.read_tasks.outputs.content }}

            å®Œæˆæ¯å€‹ä»»å‹™å¾Œï¼Œè«‹ç¢ºä¿ï¼š
            1. ç¨‹å¼ç¢¼ç¬¦åˆå°ˆæ¡ˆçš„ç·¨ç¢¼æ¨™æº–
            2. å¦‚æœæ˜¯ Flutter å°ˆæ¡ˆï¼Œè«‹ä½¿ç”¨ fvm flutter æŒ‡ä»¤
            3. åŸ·è¡Œç›¸é—œçš„æ¸¬è©¦ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
            4. å®Œæˆå¾Œè«‹ commit è®Šæ›´

          # å…è¨±åŸ·è¡Œå¸¸ç”¨çš„é–‹ç™¼æŒ‡ä»¤
          allowed_tools: |
            Bash(fvm flutter *),
            Bash(flutter *),
            Bash(dart *),
            Bash(npm *),
            Bash(git add *),
            Bash(git commit *),
            Bash(git push *),
            Bash(python *),
            Bash(pip *),
            Bash(pytest *),
            Bash(ruff *),
            Bash(black *)

      - name: Notify completion
        if: always()
        run: |
          echo "ğŸ‰ Claude ä»»å‹™è™•ç†å®Œæˆ"
          echo "è™•ç†ç‹€æ…‹: ${{ job.status }}"
          echo "è™•ç†æ™‚é–“: $(date)"

  cleanup-old-artifacts:
    needs: [check-project-items, process-with-claude]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      actions: write

    steps:
      - name: Cleanup old task artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });

            // æ¸…ç†è¶…é 7 å¤©çš„ claude-tasks artifacts
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

            for (const artifact of artifacts.data.artifacts) {
              if (artifact.name.startsWith('claude-tasks-') && 
                  new Date(artifact.created_at) < sevenDaysAgo) {
                try {
                  await github.rest.actions.deleteArtifact({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    artifact_id: artifact.id,
                  });
                  console.log(`å·²æ¸…ç†èˆŠçš„ä»»å‹™ artifact: ${artifact.name}`);
                } catch (error) {
                  console.log(`æ¸…ç† artifact ${artifact.name} æ™‚ç™¼ç”ŸéŒ¯èª¤:`, error.message);
                }
              }
            }